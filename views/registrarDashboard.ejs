<!-- http://localhost:3000/registrar -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background:#ffffff; color:#222; }
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 250px; background: #dc2626; color: #fff; padding: 22px 20px 20px; box-shadow: 2px 0 14px rgba(0,0,0,0.12); display: flex; flex-direction: column; gap: 18px; z-index: 1000; }
        .sidebar .brand { display: flex; align-items: center; gap: 12px; }
        .sidebar .brand img { width: 46px; height: 46px; border-radius: 50%; background: #fff; padding: 6px; }
        .sidebar .school-name-text { font-size: 16px; font-weight: 700; line-height: 1.2; color:#ffffff; }
        .sidebar .nav { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .sidebar .nav a { color: #fff; text-decoration: none; padding: 11px 14px; border-radius: 10px; background: rgba(255,255,255,0.10); font-weight: 600; letter-spacing: .3px; transition: background .18s, transform .18s; }
        .sidebar .nav a:hover { background: rgba(255,255,255,0.22); transform: translateX(3px); }
        .sidebar .nav a.active { background: #fff; color: #dc2626; font-weight: 700; }
        .sidebar .spacer { flex: 1; }
        .sidebar .logout-btn { display: inline-block; color: #fff; text-decoration: none; padding: 12px 14px; border-radius: 10px; background: #b91c1c; font-weight: 700; text-align: center; transition: background .18s; }
        .sidebar .logout-btn:hover { background: #991b1b; }
        main { max-width: 1400px; margin: 60px 40px 100px 310px; padding: 0; }
        /* Dashboard stat cards */
        .page-wrap { background: #fff; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); padding: 48px; border:1px solid #e8e8e8; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 32px; align-items: stretch; }
        .card-stat { background:linear-gradient(180deg, #ffffff 0%, #fff7f7 100%); border:1px solid #e8e8e8; border-radius:18px; padding:28px; min-height:140px; position:relative; box-shadow:0 4px 16px rgba(0,0,0,0.06); transition: box-shadow .22s, transform .22s; }
        .card-stat::before { content:""; position:absolute; left:0; top:0; bottom:0; width:5px; background:#dc2626; border-top-left-radius:16px; border-bottom-left-radius:16px; }
        .card-stat:hover { box-shadow:0 10px 26px rgba(0,0,0,0.12); transform:translateY(-2px); z-index:2; }
        .stat { display:flex; align-items:center; gap:18px; }
        .stat-icon { width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:26px; background:#fee2e2; color:#dc2626; flex:0 0 56px; transition: transform .22s; }
        .card-stat:hover .stat-icon { transform: scale(1.06); }
        .stat-body h3 { line-height:1.25; margin:0 0 8px 0; font-weight:700; color:#333; font-size:16px; }
        .stat-value { font-size:38px; font-weight:800; color:#dc2626; }
        .dashboard-title { 
            font-weight: 700;
            font-size: 36px !important;
            letter-spacing: -0.5px;
        }
        h2.dashboard-title { font-size: 32px !important; }
        h4 { font-size: 20px !important; font-weight: 700 !important; letter-spacing: -0.3px; margin-bottom: 20px !important; }
        h5 { font-size: 17px !important; font-weight: 700 !important; margin-bottom: 16px !important; }
        .form-section { 
            background: #fff; 
            border-radius: 16px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            padding: 36px; 
            margin-bottom: 32px; 
        }
        .table-section { 
            background: #fff; 
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06); 
            padding: 36px; 
        }
        /* Style for action buttons */
        .btn-action {
            padding: .25rem .5rem;
            font-size: .875rem;
        }
        /* Make table columns compact */
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.9em;
        }
        /* Style for the new select/specify groups */
        .specify-group {
            margin-bottom: 1.5rem;
            padding-top: 0.5rem;
        }
        .specify-input-field {
            margin-top: 0.5rem;
        }
        
        /* Input shadow styles */
        .form-control, .form-select {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08); 
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* Validation styles (applied dynamically) */
        .validation-error {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 0.15rem rgba(220,38,38,0.12) !important;
        }
        .validation-message { margin-top: 0.5rem; }
        #formAlert { margin-bottom: 1.5rem; }
        
        /* Improved spacing for info cards */
        .card.border-0.shadow-sm { border-radius: 16px !important; margin-bottom: 0; }
        .card.border-0.shadow-sm .card-body { padding: 24px; }
        
        /* Form and label improvements */
        .form-label { font-weight: 600; font-size: 15px; margin-bottom: 10px; color: #333; }
        .form-control, .form-select { border-radius: 10px; border: 1.5px solid #e5e7eb; font-size: 15px; padding: 12px 14px; }
        .form-control:focus, .form-select:focus { border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        
        /* Button improvements */
        .btn { border-radius: 10px; font-weight: 600; padding: 11px 18px; font-size: 15px; }
        .btn-danger { background: #dc2626; border: none; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-outline-danger:hover { background: #dc2626; color: white; }
        
        /* Table improvements */
        .table { font-size: 15px; }
        .table th { background: #f8f9fa; font-weight: 700; font-size: 14px; letter-spacing: 0.3px; text-transform: uppercase; color: #444; padding: 16px 12px; }
        .table td { padding: 16px 12px; vertical-align: middle; }
        .table tbody tr { border-bottom: 1px solid #f0f0f0; }
        .table tbody tr:hover { background-color: #f9f9f9; }
    
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="brand">
            <img src="/pictures/SchoolLogo-removebg-preview.png" alt="School Logo">
            <span class="school-name-text">Mainaga San Francisco Integrated School</span>
        </div>
        <nav class="nav" id="drawerTabs">
            <a href="#dashboardHome" class="active">ðŸ“Š Dashboard</a>
            <a href="#currentRegistrations">ðŸ§¾ Current Registrations</a>
            <a href="#requestList">âœ… List of Requests</a>
            <a href="#historyArchive">ðŸ“š History of Requests</a>
            <a href="#studentAccounts">ðŸ‘¤ Student Accounts</a>
            <a href="/registrar/analytics">ðŸ”’ Security</a>
        </nav>
        <div class="spacer"></div>
        <a class="logout-btn" href="#" onclick="event.preventDefault(); confirmLogout(); return false;">Logout</a>
    </aside>

    <main>
        <div class="page-wrap mb-5 tab-content-section" id="dashboardHome">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-6 pb-4 border-bottom" style="border-bottom: 2px solid #f0f0f0 !important;">
                <div>
                    <h1 class="dashboard-title mb-2" style="color: #dc2626;">Registrar Dashboard</h1>
                </div>
                <div class="text-end">
                    <div class="text-muted small" style="font-size: 14px; font-weight: 500;">Last Updated</div>
                    <div class="fw-semibold" style="font-size: 15px; color: #333; margin-top: 6px;" id="lastUpdated">
                        <%= new Date().toLocaleString('en-PH', { 
                            month: 'short', day: 'numeric', year: 'numeric', 
                            hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Manila' 
                        }) %>
                    </div>
                </div>
            </div>

            <% 
                const _requests = (typeof requests !== 'undefined' && requests) ? requests : []; 
                const _history = (typeof history !== 'undefined' && history) ? history : []; 
                const pendingCount = _requests.length; 
                const approvedCount = _history.filter(h => h.status === 'approved').length; 
                const rejectedCount = _history.filter(h => h.status !== 'approved').length; 
                const totalRequests = pendingCount + _history.length; 
                const today = new Date();
                const todayRequests = _requests.filter(r => {
                    try { const d = new Date(r.created_at); return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate(); } catch(_) { return false; }
                }).length;
            %>

            <!-- Server-provided JSON (safe injection) -->
            <script id="server_requests" type="application/json"><%- JSON.stringify(_requests || []) %></script>
            <script id="server_history" type="application/json"><%- JSON.stringify(_history || []) %></script>

            <!-- Statistics Grid -->
            <div class="row g-4 mb-5">
                <!-- Total Requests Card - DELETED -->
            </div>

            <!-- Info Cards Row -->
            <div class="row g-4 mb-5" style="display: none;">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fff7ed 0%, #fffbf5 100%);">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-4">
                                <div class="fs-1">ðŸ’¡</div>
                                <div>
                                    <div class="fw-bold text-dark mb-2" style="font-size: 16px;">Pending Actions</div>
                                    <div class="small text-muted" style="font-size: 15px;">You have <strong><%= pendingCount %></strong> request(s) waiting for review</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f0fdf4 0%, #f7fdf3 100%);">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-4">
                                <div class="fs-1">ðŸ“Š</div>
                                <div>
                                    <div class="fw-bold text-dark mb-2" style="font-size: 16px;">Processing Rate</div>
                                    <div class="small text-muted" style="font-size: 15px;">
                                        <strong><%= totalRequests > 0 ? Math.round((approvedCount / totalRequests) * 100) : 0 %>%</strong> approval rate this school year
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barangay Distribution Chart -->
            <div class="row g-4 mt-5">
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm" style="background: #fff;">
                        <div class="card-body" style="padding: 36px;">
                            <div class="d-flex justify-content-between align-items-center mb-6">
                                <div>
                                    <h5 class="card-title mb-1 text-dark fw-bold" style="font-size: 22px;">Barangay Distribution</h5>
                                    <small class="text-muted" style="font-size: 15px;">Student enrollment by barangay</small>
                                </div>
                                <div>
                                    <label class="form-label mb-1 small fw-semibold" style="font-size: 14px;">Filter by School Year:</label>
                                    <select id="barangayYearFilter" class="form-select form-select-sm" style="width: auto; min-width: 160px; border-radius: 8px;">
                                        <option value="">All Years</option>
                                    </select>
                                </div>
                            </div>
                            <div style="position: relative; height: 360px;">
                                <canvas id="barangayDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Breakdown Analysis -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm" style="background: #f8f9fa;">
                        <div class="card-body" style="padding: 36px;">
                            <h5 class="card-title mb-4 text-dark fw-bold" style="font-size: 22px;">
                                <i class="bi bi-graph-up-arrow me-2" style="color: #dc2626;"></i>Enrollment Breakdown Analysis
                            </h5>
                            
                            <div id="barangayBreakdownContainer">
                                <div class="text-muted text-center py-4" style="font-size: 15px;">
                                    <i class="bi bi-hourglass-split me-2"></i>Loading analysis...
                                </div>
                            </div>

                            <div class="mt-4 pt-4" style="border-top: 2px solid #e5e7eb;">
                                <h6 class="fw-bold mb-3" style="font-size: 15px; color: #333;">Summary Insights</h6>
                                <div id="barangaySummaryInsights" class="text-muted" style="font-size: 14px; line-height: 1.8;">
                                    <p class="mb-2">Select or filter by school year to view detailed breakdown analysis.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="currentRegistrations" class="tab-content-section" style="display:none;">
        <div class="form-section mb-5" style="border-top: 6px solid #dc2626;">
            <h4 class="mb-4 text-dark">Manually Add New Early Registration Record</h4>
            <form id="enrollmentForm">
                <!-- Alert for validation messages -->
                <div id="formAlert" class="alert alert-danger d-none" role="alert"></div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label class="form-label text-dark">Gmail Address Used for Registration</label>
                        <input type="email" class="form-control" name="gmail" required placeholder="Enter Gmail address">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-dark">School Year</label>
                        <input type="text" class="form-control" name="schoolYear" value="2025 - 2026" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">LRN</label>
                        <input type="text" class="form-control" name="lrn" placeholder="If applicable">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">Grade Level to Enroll</label>
                        <input type="text" class="form-control" name="gradeLevel" required>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3 text-dark">3. Learner's Personal Information</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label text-dark">Last Name</label>
                        <input type="text" class="form-control" name="lastName" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-dark">First Name</label>
                        <input type="text" class="form-control" name="givenName" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-dark">Middle Name</label>
                        <input type="text" class="form-control" name="middleName">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-dark">Ext. Name (if any)</label>
                        <input type="text" class="form-control" name="extName">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-dark">Birthday</label>
                        <input type="date" class="form-control" name="birthday" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">Age</label>
                        <input type="number" class="form-control" name="age" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">Sex</label>
                        <select class="form-select" name="sex" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-dark">Religion</label>
                        <input type="text" class="form-control" name="religion">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-dark">Current Address</label>
                        <input type="text" class="form-control" name="address" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-dark fw-bold">Belonging to IP Community?</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ipCommunity" id="ipNo" value="No" required>
                                <label class="form-check-label text-dark" for="ipNo">No</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ipCommunity" id="ipYes" value="Yes">
                                <label class="form-check-label text-dark" for="ipYes">Yes</label>
                            </div>
                        </div>
                        <input type="text" class="form-control mt-2" name="ipCommunitySpecify" placeholder="If Yes, specify IP Community">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-dark fw-bold">Person with Disability (PWD)?</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pwd" id="pwdNo" value="No" required>
                                <label class="form-check-label text-dark" for="pwdNo">No</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pwd" id="pwdYes" value="Yes">
                                <label class="form-check-label text-dark" for="pwdYes">Yes</label>
                            </div>
                        </div>
                        <input type="text" class="form-control mt-2" name="pwdSpecify" placeholder="If Yes, specify disability">
                    </div>
                </div>
                <hr>
                <h5 class="mb-3 text-dark">Parent/Guardian Information</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-dark">Father's Name</label>
                        <input type="text" class="form-control" name="fatherName">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">Mother's Maiden Name</label>
                        <input type="text" class="form-control" name="motherName">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-dark">Legal Guardian's Name</label>
                        <input type="text" class="form-control" name="guardianName">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-dark">Contact Number</label>
                        <input type="text" class="form-control" name="contactNumber">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-dark">Date</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3 text-dark">Signature</h5>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label text-dark">Printed Name</label>
                            <input type="text" class="form-control" name="printedName" placeholder="Type Printed Name Here" required>
                        </div>
                    </div>
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-dark">Upload E-Signature (Image)</label>
                        <input type="file" class="form-control" name="signatureImage" accept="image/*">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-dark">Or draw your e-signature below:</label>
                        <div class="d-flex align-items-center gap-2">
                            <canvas id="signaturePad" width="300" height="80" style="background:#f8f9fa; border:2px solid #dc2626; border-radius:8px;"></canvas>
                            <button type="button" id="maximizeSignaturePad" class="btn btn-outline-danger btn-sm" title="Maximize">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>
                        <button type="button" onclick="clearSignaturePad()" class="btn btn-danger btn-sm mt-2">Clear</button>
                    </div>
                </div>

                <button type="submit" class="btn btn-danger w-100 fw-bold">Add New Registration Record</button>
            </form>
        </div>
        
        <div class="table-section">
            <h4 class="mb-4">Early Registration Records</h4>
            <div class="table-responsive">
                <!-- Filters: Year, Grade, Search -->
                <div class="d-flex gap-2 align-items-center mb-3">
                    <label class="small fw-semibold mb-0">Filter:</label>
                    <select id="filterSY" class="form-select form-select-sm" style="width:auto;">
                        <option value="">All Years</option>
                    </select>
                    <select id="filterGrade" class="form-select form-select-sm" style="width:auto;">
                        <option value="">All Grades</option>
                    </select>
                    <div class="input-group input-group-sm" style="width:340px">
                        <input id="filterSearch" class="form-control" placeholder="Search LRN or Learner name" />
                        <button id="filterSearchBtn" class="btn btn-outline-secondary">Search</button>
                    </div>
                    <button id="filterClearBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>

                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>SY</th>
                            <th>Grade</th>
                            <th>Enrollee Type</th>
                            <th>Learner Name</th>
                            <th>LRN</th>
                            <th>Contact No.</th>
                            <th>Student Account</th>
                            <th>Reg. Date/Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="enrollmentTableBody">
                        <% if (typeof registrations !== 'undefined' && registrations.length > 0) { %>
                            <% registrations.forEach(function(reg) { %>
                                <tr data-school-year="<%= reg.school_year %>" data-grade="<%= reg.grade_level %>" data-learner="<%= (reg.learner_name||'').toLowerCase() %>" data-lrn="<%= (reg.lrn||'').toString().toLowerCase() %>">
                                    <td>
                                        <% if (reg.record_type === 'enrollment_request') { %>
                                            <span class="badge bg-success">Online</span>
                                        <% } else { %>
                                            <span class="badge bg-info">Paper</span>
                                        <% } %>
                                    </td>
                                    <td><%= reg.school_year %></td>
                                    <td><%= reg.grade_level %></td>
                                    <td><span class="badge bg-info"><%= reg.enrollee_type ? reg.enrollee_type.replace('-', ' ').replace('new entrant kinder', 'New Entrant - Kinder') : 'N/A' %></span></td>
                                    <td><%= reg.learner_name %></td>
                                    <td><%= reg.lrn || 'N/A' %></td>
                                    <td><%= reg.contact_number || 'N/A' %></td>
                                    <td>
                                        <% if (reg.student_id) { %>
                                            <div class="small">
                                                <strong><%= reg.student_id %></strong><br>
                                                <code class="text-muted"><%= reg.username %></code><br>
                                                <% if (reg.account_status === 'active') { %>
                                                    <span class="badge bg-success">Active</span>
                                                <% } %>
                                            </div>
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td>
                                                                                <%= reg.created_at
                                                                                        ? new Date(reg.created_at).toLocaleString('en-PH', {
                                                                                                year: 'numeric', month: '2-digit', day: '2-digit',
                                                                                                hour: '2-digit', minute: '2-digit', second: '2-digit',
                                                                                                hour12: true, timeZone: 'Asia/Manila'
                                                                                            })
                                                                                        : (reg.registration_date
                                                                                                ? new Date(reg.registration_date).toLocaleString('en-PH', {
                                                                                                        year: 'numeric', month: '2-digit', day: '2-digit',
                                                                                                        timeZone: 'Asia/Manila'
                                                                                                    })
                                                                                                : 'N/A')
                                                                                %>
                                                                        </td>
                                        <td>
                                            <a class="btn btn-info btn-action" href="/registration/<%= reg.id %>">View</a>
                                        </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="10" class="text-center">No registration records found</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="requestList" class="tab-content-section" style="display: none;">
        <h2 class="dashboard-title mb-5">List of Pending Registration Requests</h2>
        <div class="table-section">
            <div class="table-responsive">
                <!-- Request List filters: Grade + Search -->
                <div class="d-flex gap-2 align-items-center mb-3">
                    <label class="small fw-semibold mb-0">Filter:</label>
                    <select id="requestListFilterGrade" class="form-select form-select-sm" style="width:auto;">
                        <option value="">All Grades</option>
                    </select>
                    <div class="input-group input-group-sm" style="width:340px">
                        <input id="requestListFilterSearch" class="form-control" placeholder="Search Token, LRN or Learner name" />
                        <button id="requestListFilterSearchBtn" class="btn btn-outline-secondary">Search</button>
                    </div>
                    <button id="requestListFilterClearBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Learner Name</th>
                            <th>Grade Level</th>
                            <th>Email</th>
                            <th>Contact No.</th>
                            <th>Submitted At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof requests !== 'undefined' && requests.length > 0) { %>
                            <% requests.forEach(function(req) { %>
                                <tr data-grade="<%= req.grade_level %>" data-learner="<%= (req.learner_name||'').toLowerCase() %>" data-token="<%= (req.request_token||'').toLowerCase() %>" data-lrn="<%= (req.lrn||'').toString().toLowerCase() %>">
                                    <td><code><%= req.request_token %></code></td>
                                    <td><%= req.learner_name %></td>
                                    <td><%= req.grade_level %></td>
                                    <td><%= req.gmail_address %></td>
                                    <td><%= req.contact_number || 'N/A' %></td>
                                    <td><%= new Date(req.registration_date).toLocaleString('en-PH', {
                                        year: 'numeric', month: '2-digit', day: '2-digit',
                                        hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Manila'
                                    }) %></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="openFillDetails('<%= req.id %>')">View/Fill Details</button>
                                            <button class="btn btn-sm btn-success" onclick="approveRequest('<%= req.id %>')">Approve</button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectRequest('<%= req.id %>')">Reject</button>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="text-center">No pending requests</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyArchive" class="tab-content-section" style="display: none;">
        <h2 class="dashboard-title mb-5">Registration Request History</h2>
        <div class="table-section">
            <div class="table-responsive">
                <!-- History filters: Grade + Search -->
                <div class="d-flex gap-2 align-items-center mb-3">
                    <label class="small fw-semibold mb-0">Filter:</label>
                    <select id="historyFilterGrade" class="form-select form-select-sm" style="width:auto;">
                        <option value="">All Grades</option>
                    </select>
                    <div class="input-group input-group-sm" style="width:340px">
                        <input id="historyFilterSearch" class="form-control" placeholder="Search Token, LRN or Learner name" />
                        <button id="historyFilterSearchBtn" class="btn btn-outline-secondary">Search</button>
                    </div>
                    <button id="historyFilterClearBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>

                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Learner Name</th>
                            <th>Grade Level</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Student Account</th>
                            <th>Reviewed At</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof history !== 'undefined' && history.length > 0) { %>
                            <% history.forEach(function(h) { %>
                                <tr data-grade="<%= h.grade_level %>" data-learner="<%= (h.learner_name||'').toLowerCase() %>" data-token="<%= (h.request_token||'').toLowerCase() %>" data-lrn="<%= (h.lrn||'').toString().toLowerCase() %>">
                                    <td><code><%= h.request_token %></code></td>
                                    <td><%= h.learner_name %></td>
                                    <td><%= h.grade_level %></td>
                                    <td><%= h.gmail_address %></td>
                                    <td>
                                        <% if (h.status === 'approved') { %>
                                            <span class="badge bg-success">Approved</span>
                                        <% } else { %>
                                            <span class="badge bg-danger">Rejected</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (h.student_id) { %>
                                            <div class="small">
                                                <strong><%= h.student_id %></strong><br>
                                                <code class="text-muted"><%= h.username %></code><br>
                                                <% if (h.account_status === 'active') { %>
                                                    <span class="badge bg-success">Active</span>
                                                <% } else { %>
                                                    <span class="badge bg-secondary">Inactive</span>
                                                <% } %>
                                            </div>
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td><%= h.reviewed_at ? new Date(h.reviewed_at).toLocaleString('en-PH', {
                                        year: 'numeric', month: '2-digit', day: '2-digit',
                                        hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Manila'
                                    }) : 'N/A' %></td>
                                    <td><%= h.rejection_reason || '-' %></td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center">No history records</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
        </div>

    </main>
<!-- Signature Pad Modal -->
<div class="modal fade" id="signaturePadModal" tabindex="-1" aria-labelledby="signaturePadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header" style="border-bottom: 1px solid #dc2626;">
    <h5 class="modal-title text-dark" id="signaturePadModalLabel">Draw E-Signature</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeSignaturePadModal"></button>
      </div>
      <div class="modal-body" style="padding: 2rem 1.5rem;">
        <div class="d-flex justify-content-center mb-3">
          <canvas id="signaturePadModalCanvas" width="480" height="180"
            style="background:#f8f9fa; border:2px solid #dc2626; border-radius:12px; box-shadow:0 2px 8px rgba(220,38,38,0.08);"></canvas>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-danger btn-sm px-4" id="clearModalSignaturePad">Clear</button>
          <button type="button" class="btn btn-outline-danger btn-sm px-4" id="doneModalSignaturePad">Done</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-labelledby="logoutConfirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 18px; border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
      <div class="modal-header" style="border-bottom: 2px solid #f0f0f0; background: linear-gradient(135deg, #fff5f5 0%, #fffbf9 100%); padding: 32px;">
        <div class="d-flex align-items-center gap-3 w-100">
          <div style="width: 56px; height: 56px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">
            ðŸ‘‹
          </div>
          <div>
            <h5 class="modal-title text-dark fw-bold" id="logoutConfirmModalLabel" style="font-size: 20px; margin: 0;">Confirm Logout</h5>
            <small class="text-muted">You will be signed out of your account</small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="margin: 0;"></button>
      </div>
      <div class="modal-body" style="padding: 36px;">
        <div class="text-center">
          <p class="text-muted mb-0" style="font-size: 16px; line-height: 1.6;">
            Are you sure you want to log out? You'll need to sign in again to access the registrar dashboard.
          </p>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 2px solid #f0f0f0; padding: 20px 32px; background: #f9f9f9; gap: 12px;">
        <button type="button" class="btn btn-light fw-semibold" data-bs-dismiss="modal" style="border: 1.5px solid #e5e7eb; padding: 11px 28px; border-radius: 10px; color: #333;">Cancel</button>
        <button type="button" class="btn btn-danger fw-semibold" onclick="proceedLogout()" style="padding: 11px 28px; border-radius: 10px; background: #dc2626; border: none;">
          <i class="bi bi-box-arrow-right me-2"></i>Yes, Log Out
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View/Fill Missing Details Modal -->
<div class="modal fade" id="fillDetailsModal" tabindex="-1" aria-labelledby="fillDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header" style="border-bottom: 1px solid #dc2626; background: #fff;">
    <h5 class="modal-title text-dark fw-bold" id="fillDetailsModalLabel">
          <i class="bi bi-card-checklist me-2"></i>Enrollment Request Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="background: #f8f9fa; padding: 1.5rem;">
        <input type="hidden" id="fillRequestId">
        
        <!-- Request Info Card -->
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-info-circle me-2"></i>Request Information
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label text-muted small">Request Token</label>
                <div class="fw-bold" id="view_request_token">-</div>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Gmail Address</label>
                <div class="fw-semibold" id="view_gmail_address">-</div>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Submitted On</label>
                <div class="fw-semibold" id="view_created_at">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Learner Info Card -->
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-person me-2"></i>Learner Information
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label text-muted small">School Year</label>
                <div class="fw-semibold" id="view_school_year">-</div>
              </div>
              <div class="col-md-3">
                <label class="form-label text-muted small">Grade Level</label>
                <div class="fw-semibold" id="view_grade_level">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">LRN</label>
                <div class="fw-semibold" id="view_lrn">-</div>
              </div>
              <div class="col-md-3">
                <label class="form-label text-muted small">Last Name</label>
                <div class="fw-semibold" id="view_last_name">-</div>
              </div>
              <div class="col-md-3">
                <label class="form-label text-muted small">First Name</label>
                <div class="fw-semibold" id="view_first_name">-</div>
              </div>
              <div class="col-md-3">
                <label class="form-label text-muted small">Middle Name</label>
                <div class="fw-semibold" id="view_middle_name">-</div>
              </div>
              <div class="col-md-3">
                <label class="form-label text-muted small">Ext. Name</label>
                <div class="fw-semibold" id="view_ext_name">-</div>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Birthday</label>
                <div class="fw-semibold" id="view_birthday">-</div>
              </div>
              <div class="col-md-2">
                <label class="form-label text-muted small">Age</label>
                <div class="fw-semibold" id="view_age">-</div>
              </div>
              <div class="col-md-2">
                <label class="form-label text-muted small">Sex</label>
                <div class="fw-semibold" id="view_sex">-</div>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Printed Name</label>
                <div class="fw-semibold" id="view_printed_name">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Address & Additional Info (read-only + editable) -->
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-geo-alt me-2"></i>Address & Additional Information
          </div>
          <div class="card-body">
            <form id="fillDetailsForm">
              <div class="row g-3">
                <div class="col-md-12">
                  <label class="form-label fw-semibold">Current Address</label>
                  <input type="text" class="form-control" id="current_address" placeholder="Street, Barangay, City, Province">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Religion</label>
                  <input type="text" class="form-control" id="religion_fill">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Contact Number</label>
                  <input type="text" class="form-control" id="contact_number" placeholder="e.g., 09XXXXXXXXX">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Belonging to IP Community?</label>
                  <select class="form-select" id="ip_community">
                    <option value="">Select</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                  <input type="text" class="form-control mt-2" id="ip_community_specify" placeholder="If Yes, specify IP Community">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Person with Disability (PWD)?</label>
                  <select class="form-select" id="pwd_fill">
                    <option value="">Select</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                  <input type="text" class="form-control mt-2" id="pwd_specify" placeholder="If Yes, specify disability">
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Parent/Guardian Info (editable) -->
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-people me-2"></i>Parent / Guardian Information
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Father's Name</label>
                <input type="text" class="form-control" id="father_name" placeholder="Last, First Middle Suffix">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Mother's Maiden Name</label>
                <input type="text" class="form-control" id="mother_name" placeholder="Last, First Middle Suffix">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Legal Guardian's Name</label>
                <input type="text" class="form-control" id="guardian_name" placeholder="Last, First Middle Suffix">
              </div>
            </div>
          </div>
        </div>

        <!-- Enrollee Type & Documents -->
        <div class="card mb-3 shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-file-earmark-text me-2"></i>Enrollee Type & Documents
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label fw-semibold">Enrollee Type</label>
                <div id="view_enrollee_type_detail" class="fw-semibold p-2 bg-light rounded">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">Birth Certificate - PSA</label>
                <div id="view_birth_cert_psa" class="text-muted">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">ECCD Checklist</label>
                <div id="view_eccd_checklist" class="text-muted">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">Report Card (Previous)</label>
                <div id="view_report_card_previous" class="text-muted">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">SF 10 Original</label>
                <div id="view_sf10_original" class="text-muted">-</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">SF 10 Optional</label>
                <div id="view_sf10_optional" class="text-muted">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signature Preview -->
        <div class="card shadow-sm">
          <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-pen me-2"></i>E-Signature
          </div>
          <div class="card-body text-center">
            <div id="signature_preview_container" style="display: none;">
              <img id="signature_preview" src="" alt="E-Signature" style="max-width: 300px; border: 1px solid #ddd; border-radius: 8px; padding: 0.5rem; background: #f8f9fa;">
            </div>
            <div id="signature_no_preview" class="text-muted">No signature uploaded</div>
          </div>
        </div>

      </div>
      <div class="modal-footer" style="border-top: 1px solid #dee2e6; background: #fff;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="saveFillDetails">
          <i class="bi bi-save me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="bi bi-file-earmark me-2"></i>
          <span id="document_title">Document Viewer</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-4">
        <div id="document_viewer_content" style="max-height: 600px; overflow: auto;">
          <!-- Document will be displayed here -->
        </div>
      </div>
      <div class="modal-footer">
        <a id="document_download_btn" href="#" download class="btn btn-primary">
          <i class="bi bi-download me-2"></i>Download
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Student Accounts Section -->
<div id="studentAccounts" class="tab-content-section" style="display: none;">
  <h2 class="dashboard-title mb-4">Student Accounts</h2>
  <p class="text-muted mb-4">View all created student accounts and their login credentials</p>
  
  <!-- Search Bar -->
  <div class="mb-4">
    <div class="input-group">
      <span class="input-group-text bg-white border-end-0">
        <i class="bi bi-search"></i>
      </span>
      <input 
        type="text" 
        class="form-control border-start-0" 
        id="studentAccountsSearch" 
        placeholder="Search by Student ID, Name, Username, or Email..."
        style="border-left: none;"
      >
    </div>
  </div>

  <div class="table-section">
    <div class="table-responsive">
      <table class="table table-hover table-sm" id="studentAccountsTable" style="margin-bottom: 0; font-size: 0.9rem;">
        <thead class="table-light">
          <tr>
            <th style="width: 12%;">Student ID</th>
            <th style="width: 18%;">Student Name</th>
            <th style="width: 14%;">Username</th>
            <th style="width: 20%;">Email</th>
            <th style="width: 12%;">Status</th>
            <th style="width: 12%;">Created</th>
            <th style="width: 12%; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="studentAccountsTableBody">
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <i class="bi bi-inbox"></i> No student accounts created yet
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Password Reference Section -->
  <div class="alert alert-info mt-3" style="font-size: 0.85rem;">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Initial passwords</strong> are shown in the account creation confirmation. Students can change their password after first login.
  </div>
</div>

<!-- Student Account Creation Modal -->
<div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="createAccountModalLabel">
          <i class="bi bi-person-plus me-2"></i>Create Student Account
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-4">
          A new student account will be created with the credentials below. Share these with the student to login.
        </p>
        
        <!-- Student Info -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Student Name</label>
          <input type="text" class="form-control" id="accountModalStudentName" disabled>
        </div>
        
        <!-- Generated Credentials (Read-only) -->
        <div class="card mb-3" style="background-color: #f0fdf4; border: 2px solid #10b981;">
          <div class="card-body">
            <h6 class="card-title fw-bold text-success mb-3">Generated Credentials</h6>
            
            <div class="mb-2">
              <label class="form-label fw-semibold small">Username / Student ID</label>
              <input type="text" class="form-control font-monospace" id="accountModalUsername" readonly>
            </div>
            
            <div class="mb-2">
              <label class="form-label fw-semibold small">Initial Password</label>
              <input type="text" class="form-control font-monospace" id="accountModalPassword" readonly>
            </div>
            
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>Student will receive these credentials via their enrollment token
            </small>
          </div>
        </div>
        
        <!-- Token Delivery Alert -->
        <div class="alert alert-info" role="alert">
          <i class="bi bi-ticket me-2"></i>
          <strong>Delivery:</strong> Credentials will be sent to the student via their enrollment token request
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmCreateAccountBtn" onclick="confirmCreateAccount()">
          <i class="bi bi-check-circle me-2"></i>Confirm & Create Account
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Student Account Modal -->
<div class="modal fade" id="editStudentAccountModal" tabindex="-1" aria-labelledby="editStudentAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editStudentAccountModalLabel">
          <i class="bi bi-pencil-square me-2"></i>Edit Student Account
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editStudentAccountForm">
          <!-- Student ID (Read-only) -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Student ID</label>
            <input type="text" class="form-control" id="editStudentId" readonly>
          </div>

          <!-- Username (Read-only) -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Username</label>
            <input type="text" class="form-control" id="editUsername" readonly>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Email Address</label>
            <input type="email" class="form-control" id="editEmail" placeholder="student@example.com">
            <small class="text-muted">Email for account communications</small>
          </div>

          <!-- Account Status -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Account Status</label>
            <select class="form-select" id="editAccountStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>

          <!-- Password Reset Section -->
          <div class="card bg-light border-warning mb-3">
            <div class="card-body">
              <h6 class="card-title fw-bold mb-3">
                <i class="bi bi-key me-2"></i>Reset Password
              </h6>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enablePasswordReset">
                <label class="form-check-label" for="enablePasswordReset">
                  Generate new password for student
                </label>
              </div>
              <div id="passwordResetSection" style="display: none; margin-top: 10px;">
                <small class="text-muted d-block mb-2">A new password will be generated. The student will receive it in their confirmation email.</small>
                <div class="alert alert-warning alert-sm py-2 px-3">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  Student must change password on first login.
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditStudentBtn" onclick="saveEditStudent()">
          <i class="bi bi-check-circle me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// ===== Document Viewer Function =====
function viewDocument(docName, btn) {
    const docData = window.currentEnrollmentDocuments?.[docName];
    if (!docData) {
        alert('Document data not available');
        return;
    }
    
    // Format document name for display
    const docTitles = {
        'birth_cert_psa': 'Birth Certificate - PSA',
        'eccd_checklist': 'ECCD Checklist',
        'report_card_previous': 'Report Card (Previous)',
        'sf10_original': 'SF 10 Original',
        'sf10_optional': 'SF 10 Optional'
    };
    
    const title = docTitles[docName] || docName;
    
    // Set document viewer modal
    document.getElementById('document_title').textContent = title;
    
    // Determine if it's an image or document
    if (docData.includes('image/')) {
        // Display as image
        document.getElementById('document_viewer_content').innerHTML = 
            `<img src="${docData}" alt="${title}" style="max-width: 100%; max-height: 500px; border: 1px solid #ddd; border-radius: 8px;">`;
    } else if (docData.includes('pdf')) {
        // Display PDF
        document.getElementById('document_viewer_content').innerHTML = 
            `<embed src="${docData}" type="application/pdf" width="100%" height="500px">`;
    } else {
        // Display as generic document
        document.getElementById('document_viewer_content').innerHTML = 
            `<div class="alert alert-info">Document type: ${docData.substring(5, 30)}</div>
             <img src="${docData}" alt="${title}" style="max-width: 100%; max-height: 500px; border: 1px solid #ddd; border-radius: 8px;">`;
    }
    
    // Set download link
    const downloadBtn = document.getElementById('document_download_btn');
    downloadBtn.href = docData;
    downloadBtn.download = title.replace(/\s+/g, '_') + '.pdf';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
    modal.show();
}

// ===== Barangay Distribution Chart =====
(function initBarangayDistribution() {
    let barangayChart = null;
    let earlyRegData = [];
    
    // Extract barangay from address string
    function extractBarangay(addressStr) {
        if (!addressStr) return 'Others';
        const lower = addressStr.toLowerCase();
        
        if (lower.includes('mainaga')) return 'Mainaga';
        if (lower.includes('san francisco')) return 'San Francisco';
        if (lower.includes('calamias')) return 'Calamias';
        
        return 'Others';
    }
    
    // Get all unique school years from data
    function getSchoolYears() {
        const years = new Set();
        earlyRegData.forEach(record => {
            if (record.school_year) {
                years.add(record.school_year);
            }
        });
        return Array.from(years).sort().reverse();
    }
    
    // Calculate barangay distribution for a specific year (or all years)
    function calculateBarangayDistribution(filterYear = null) {
        const barangayCounts = {
            'Mainaga': 0,
            'San Francisco': 0,
            'Calamias': 0,
            'Others': 0
        };
        
        earlyRegData.forEach(record => {
            if (filterYear && record.school_year !== filterYear) return;
            
            const barangay = extractBarangay(record.current_address);
            if (barangayCounts.hasOwnProperty(barangay)) {
                barangayCounts[barangay]++;
            }
        });
        
        return barangayCounts;
    }
    
    // Render the chart
    function renderBarangayChart(filterYear = null) {
        const ctx = document.getElementById('barangayDistributionChart');
        if (!ctx) return;
        
        const distribution = calculateBarangayDistribution(filterYear);
        const labels = Object.keys(distribution);
        const data = Object.values(distribution);
        
        // Destroy existing chart if any
        if (barangayChart) {
            barangayChart.destroy();
        }
        
        const colors = ['#dc2626', '#3b82f6', '#10b981', '#f59e0b'];
        
        barangayChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Students',
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverBorderColor: '#ffffff',
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 16,
                            font: { size: 12, weight: '600' },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
        
        // Update breakdown analysis
        updateBarangayBreakdown(distribution, filterYear);
    }
    
    // Generate breakdown analysis
    function updateBarangayBreakdown(distribution, filterYear) {
        const container = document.getElementById('barangayBreakdownContainer');
        const insightsContainer = document.getElementById('barangaySummaryInsights');
        
        if (!container || !insightsContainer) return;
        
        const total = Object.values(distribution).reduce((a, b) => a + b, 0);
        
        if (total === 0) {
            container.innerHTML = '<div class="text-muted text-center py-4" style="font-size: 15px;"><i class="bi bi-info-circle me-2"></i>No data available for the selected year</div>';
            insightsContainer.innerHTML = '<p class="mb-0">No enrollment data found. Select a different school year or check your records.</p>';
            return;
        }
        
        // Create breakdown HTML
        let breakdownHTML = '';
        const barangayOrder = ['Mainaga', 'San Francisco', 'Calamias', 'Others'];
        const colors = ['#dc2626', '#3b82f6', '#10b981', '#f59e0b'];
        
        barangayOrder.forEach((barangay, index) => {
            const count = distribution[barangay] || 0;
            const percentage = ((count / total) * 100).toFixed(1);
            const color = colors[index];
            
            breakdownHTML += `
                <div class="mb-3 pb-3" style="border-bottom: 1px solid #e5e7eb;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="d-inline-block" style="width: 12px; height: 12px; background: ${color}; border-radius: 50%;"></span>
                            <span class="fw-semibold text-dark" style="font-size: 15px;">${barangay}</span>
                        </div>
                        <span class="badge" style="background: ${color}; font-size: 13px;">${count} students</span>
                    </div>
                    <div class="progress" style="height: 8px; background: #e5e7eb;">
                        <div class="progress-bar" style="width: ${percentage}%; background: ${color}; border-radius: 4px;"></div>
                    </div>
                    <small class="text-muted d-block mt-1" style="font-size: 13px;">${percentage}% of total enrollment</small>
                </div>
            `;
        });
        
        container.innerHTML = breakdownHTML;
        
        // Generate insights
        const mainagaCount = distribution['Mainaga'] || 0;
        const sanFranciscoCount = distribution['San Francisco'] || 0;
        const calamiasCount = distribution['Calamias'] || 0;
        const othersCount = distribution['Others'] || 0;
        
        const largestBarangay = Math.max(mainagaCount, sanFranciscoCount, calamiasCount, othersCount);
        const largestBarangayName = Object.keys(distribution).find(key => distribution[key] === largestBarangay);
        const largestPercentage = ((largestBarangay / total) * 100).toFixed(1);
        
        let insightsHTML = `
            <p class="mb-3"><strong>Total Students Enrolled:</strong> <span style="font-size: 18px; font-weight: 700; color: #dc2626;">${total}</span></p>
            <p class="mb-3"><strong>Highest Enrollment:</strong> ${largestBarangayName} with ${largestBarangay} students (${largestPercentage}%)</p>
        `;
        
        if (mainagaCount > 0 && sanFranciscoCount > 0) {
            const difference = Math.abs(mainagaCount - sanFranciscoCount);
            insightsHTML += `<p class="mb-3"><strong>Distribution Difference:</strong> Mainaga and San Francisco differ by ${difference} students</p>`;
        }
        
        const localBarangays = mainagaCount + sanFranciscoCount + calamiasCount;
        const localPercentage = ((localBarangays / total) * 100).toFixed(1);
        insightsHTML += `<p class="mb-0"><strong>Local Barangays Coverage:</strong> ${localPercentage}% of students from Mainaga, San Francisco, and Calamias</p>`;
        
        insightsContainer.innerHTML = insightsHTML;
    }
    
    // Initialize year filter dropdown
    function initYearFilter() {
        const filterSelect = document.getElementById('barangayYearFilter');
        if (!filterSelect) return;
        
        const years = getSchoolYears();
        
        // Clear existing options except the first "All Years"
        filterSelect.innerHTML = '<option value="">All Years</option>';
        
        years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            filterSelect.appendChild(option);
        });
        
        // Add change event listener
        filterSelect.addEventListener('change', function() {
            const selectedYear = this.value;
            renderBarangayChart(selectedYear || null);
        });
    }
    
    // Fetch data from API
    async function fetchBarangayData() {
        try {
            const response = await fetch('/api/early-registrations');
            if (!response.ok) {
                console.error('Failed to fetch early registrations:', response.statusText);
                return;
            }
            
            const data = await response.json();
            earlyRegData = Array.isArray(data) ? data : (data.data || []);
            
            // Initialize filter and render chart after data is loaded
            initYearFilter();
            renderBarangayChart();
        } catch (error) {
            console.error('Error fetching barangay data:', error);
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchBarangayData();
    });
    
    // Expose function to window for external access if needed
    window.renderBarangayChart = renderBarangayChart;
})();
</script>
<script>(function(){try{
    // Read server-provided JSON from safe script blocks
    const __requestsData = (function(){ try { const el = document.getElementById('server_requests'); return el ? JSON.parse(el.textContent) : []; } catch(e){ console.error('parse server_requests', e); return []; } })();
    const __historyData = (function(){ try { const el = document.getElementById('server_history'); return el ? JSON.parse(el.textContent) : []; } catch(e){ console.error('parse server_history', e); return []; } })();

    // Format a small trend element: arrow + percent
    function renderTrend(containerId, current, previous, labelText = 'vs prior period') {
        const el = document.getElementById(containerId);
        if (!el) return;
        if ((!previous || previous === 0) && (!current || current === 0)) {
            el.innerHTML = `<span style="color:#6b7280">â€” no change</span>`;
            return;
        }
        let pct = 0;
        if (!previous || previous === 0) pct = 100;
        else pct = Math.round(((current - previous) / previous) * 100);

        const up = pct > 0;
        const neutral = pct === 0;
        const color = neutral ? '#6b7280' : (up ? '#059669' : '#dc2626');
        const arrow = neutral ? 'â€”' : (up ? 'â–²' : 'â–¼');
        el.innerHTML = `<span style="color:${color}; font-weight:700;">${arrow} ${Math.abs(pct)}%</span> <span style="color:#6b7280">${labelText}</span>`;
    }

            // Create a Year-only filter UI and wire events
            (function createYearFilterUI(){
                try {
                    // Year filter UI creation disabled - removed as requested
                } catch (err) { /* ignore */ }
            })();    // --- Request List table filtering UI (pending requests) ---
    (function initRequestListFilters(){
        try {
            const container = document.getElementById('requestList');
            if (!container) return;
            const table = container.querySelector('table.table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const gradeSelect = document.getElementById('requestListFilterGrade');
            const searchInput = document.getElementById('requestListFilterSearch');
            const searchBtn = document.getElementById('requestListFilterSearchBtn');
            const clearBtn = document.getElementById('requestListFilterClearBtn');

            const grades = new Set();
            rows.forEach(r => { const g = (r.dataset.grade||'').toString(); if (g) grades.add(g); });
            Array.from(grades).sort().forEach(g => { const o = document.createElement('option'); o.value = g; o.textContent = g; gradeSelect.appendChild(o); });

            function applyReqFilters(){
                const grade = (gradeSelect.value||'').toString();
                const term = (searchInput.value||'').toString().trim().toLowerCase();
                rows.forEach(r => {
                    const rgrade = (r.dataset.grade||'').toString();
                    const rlearner = (r.dataset.learner||'').toString();
                    const rtoken = (r.dataset.token||'').toString();
                    const rlrn = (r.dataset.lrn||'').toString();
                    let visible = true;
                    if (grade && rgrade !== grade) visible = false;
                    if (term) {
                        if (!(rlearner.includes(term) || rtoken.includes(term) || rlrn.includes(term))) visible = false;
                    }
                    r.style.display = visible ? '' : 'none';
                });
            }

            gradeSelect.addEventListener('change', applyReqFilters);
            searchBtn.addEventListener('click', (e)=>{ e.preventDefault(); applyReqFilters(); });
            searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); applyReqFilters(); } });
            clearBtn.addEventListener('click', (e)=>{ e.preventDefault(); gradeSelect.value=''; searchInput.value=''; applyReqFilters(); });
        } catch (err) { console.warn('Request list filter init failed', err); }
    })();

    // Main trend computation function; optional ISO date strings for from/to filter
    function computeAndRenderTrends(filterFromISO, filterToISO){
        try {
            const MS_DAY = 24*60*60*1000;
            let now = new Date();

            let recentStart, recentEnd;
            if (filterFromISO || filterToISO) {
                recentStart = filterFromISO ? new Date(filterFromISO) : new Date(0);
                // if no to provided, use end of day of from or now
                recentEnd = filterToISO ? new Date(filterToISO + 'T23:59:59') : now;
            } else {
                recentEnd = now;
                recentStart = new Date(now.getTime() - (7 * MS_DAY));
            }

            const prevStart = new Date(recentStart.getTime() - (7 * MS_DAY));
            const prevEnd = new Date(recentStart.getTime() - 1);

            function toDateObj(r, fields) {
                for (const f of fields) {
                    if (r[f]) return new Date(r[f]);
                }
                return null;
            }

            function countInRange(arr, fields, start, end) {
                return arr.reduce((acc, r) => {
                    const d = toDateObj(r, fields);
                    if (!d || isNaN(d)) return acc;
                    if (d >= start && d <= end) return acc + 1;
                    return acc;
                }, 0);
            }

            // Total requests: compare created_at across both arrays
            const totalRecent = countInRange(__requestsData.concat(__historyData), ['created_at','createdAt','created'], recentStart, recentEnd);
            const totalPrev = countInRange(__requestsData.concat(__historyData), ['created_at','createdAt','created'], prevStart, prevEnd);
            renderTrend('trend_total', totalRecent, totalPrev, 'vs prior 7d');

            // Pending: from requests set (created_at)
            const pendingRecent = countInRange(__requestsData, ['created_at','createdAt','created'], recentStart, recentEnd);
            const pendingPrev = countInRange(__requestsData, ['created_at','createdAt','created'], prevStart, prevEnd);
            renderTrend('trend_pending', pendingRecent, pendingPrev, 'vs prior 7d');

            // Approved: use reviewed_at or reviewedAt in history
            const approvedRecent = countInRange(__historyData.filter(h => h.status === 'approved'), ['reviewed_at','reviewedAt','updated_at'], recentStart, recentEnd);
            const approvedPrev = countInRange(__historyData.filter(h => h.status === 'approved'), ['reviewed_at','reviewedAt','updated_at'], prevStart, prevEnd);
            renderTrend('trend_approved', approvedRecent, approvedPrev, 'vs prior 7d');

            // Rejected: history where status != approved
            const rejectedRecent = countInRange(__historyData.filter(h => h.status !== 'approved'), ['reviewed_at','reviewedAt','updated_at'], recentStart, recentEnd);
            const rejectedPrev = countInRange(__historyData.filter(h => h.status !== 'approved'), ['reviewed_at','reviewedAt','updated_at'], prevStart, prevEnd);
            renderTrend('trend_rejected', rejectedRecent, rejectedPrev, 'vs prior 7d');

            // Today: compare today vs yesterday (use created_at)
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayEnd = new Date(todayStart.getTime() + MS_DAY - 1);
            const yesterdayStart = new Date(todayStart.getTime() - MS_DAY);
            const yesterdayEnd = new Date(todayStart.getTime() - 1);
            const todayCount = countInRange(__requestsData.concat(__historyData), ['created_at','createdAt','created'], todayStart, todayEnd);
            const yesterdayCount = countInRange(__requestsData.concat(__historyData), ['created_at','createdAt','created'], yesterdayStart, yesterdayEnd);
            renderTrend('trend_today', todayCount, yesterdayCount, 'vs yesterday');

        } catch (err) {
            console.error('Trend compute error', err);
        }
    }

    // Initial render with defaults
    computeAndRenderTrends();
    
    // Populate stat card values - ensure data is ready
    function populateStatCardValues() {
        try {
            const requestsEl = document.getElementById('server_requests');
            const historyEl = document.getElementById('server_history');
            
            let requestsData = [];
            let historyData = [];
            
            if (requestsEl && requestsEl.textContent) {
                try {
                    const content = requestsEl.textContent.trim();
                    if (content) {
                        requestsData = JSON.parse(content) || [];
                    }
                } catch(e) { 
                    console.warn('Could not parse requests:', e); 
                }
            }
            
            if (historyEl && historyEl.textContent) {
                try {
                    const content = historyEl.textContent.trim();
                    if (content) {
                        historyData = JSON.parse(content) || [];
                    }
                } catch(e) { 
                    console.warn('Could not parse history:', e, 'Content:', historyEl.textContent.substring(0, 100)); 
                }
            }
            
            // Total is based on history records only (approved + rejected)
            const totalCount = Array.isArray(historyData) ? historyData.length : 0;
            const pendingCount = Array.isArray(requestsData) ? requestsData.length : 0;
            const approvedCount = Array.isArray(historyData) ? historyData.filter(h => h && h.status === 'approved').length : 0;
            const rejectedCount = Array.isArray(historyData) ? historyData.filter(h => h && h.status !== 'approved').length : 0;
            
            const totalEl = document.getElementById('val_total');
            const pendingEl = document.getElementById('val_pending');
            const approvedEl = document.getElementById('val_approved');
            const rejectedEl = document.getElementById('val_rejected');
            
            if (totalEl) totalEl.textContent = totalCount;
            if (pendingEl) pendingEl.textContent = pendingCount;
            if (approvedEl) approvedEl.textContent = approvedCount;
            if (rejectedEl) rejectedEl.textContent = rejectedCount;
            
            console.log('Stat values populated:', { totalCount, pendingCount, approvedCount, rejectedCount });
        } catch (err) {
            console.error('Error populating stat values', err);
        }
    }
    
    // Call immediately and also on page load
    populateStatCardValues();
    document.addEventListener('DOMContentLoaded', populateStatCardValues);

    // Helper to compute trends for a full calendar year
    function computeAndRenderTrendsByYear(year){
        if (!year) { computeAndRenderTrends(); return; }
        const from = new Date(year, 0, 1).toISOString().slice(0,10);
        const to = new Date(year, 11, 31).toISOString().slice(0,10);
        computeAndRenderTrends(from, to);
    }
        // --- TAB SWITCHING LOGIC (hash-based, matches sidebar) ---
        function showTab(tabId) {
            // Hide all content sections
            document.querySelectorAll('.tab-content-section').forEach(el => { el.style.display = 'none'; });
            const target = document.getElementById(tabId);
            if (target) target.style.display = '';
            // Update active state in sidebar
            document.querySelectorAll('#drawerTabs a').forEach(a => {
                const href = a.getAttribute('href');
                if (href && href.startsWith('#')) {
                    if (href === `#${tabId}`) a.classList.add('active'); else a.classList.remove('active');
                }
            });
            // Sync URL hash
            if (location.hash !== `#${tabId}`) history.replaceState(null, '', `#${tabId}`);
        }

        // Load student accounts when tab is clicked
        // Global variable to store all accounts for search
        let allStudentAccounts = [];

        async function loadStudentAccounts() {
            try {
                const response = await fetch('/api/student-accounts');
                const data = await response.json();
                
                if (!data.success) {
                    return;
                }
                
                allStudentAccounts = data.accounts || [];
                renderStudentAccountsTable(allStudentAccounts);
            } catch (err) {
                console.error('Error loading student accounts:', err);
            }
        }

        function renderStudentAccountsTable(accounts) {
            const tableBody = document.getElementById('studentAccountsTableBody');
            
            if (!accounts || accounts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> No student accounts found
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            accounts.forEach(account => {
                const studentName = `${account.first_name || ''} ${account.last_name || ''}`.trim() || 'N/A';
                const statusBadge = account.account_status === 'active' 
                    ? '<span class="badge bg-success">Active</span>' 
                    : account.account_status === 'suspended'
                    ? '<span class="badge bg-danger">Suspended</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';
                const createdDate = new Date(account.created_at).toLocaleDateString('en-PH');
                
                html += `
                    <tr>
                        <td><strong>${account.student_id}</strong></td>
                        <td>${studentName}</td>
                        <td><code style="user-select: all; cursor: pointer; background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">${account.username}</code></td>
                        <td>${account.email || account.gmail_address || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-sm btn-outline-primary me-1" title="Edit Account" onclick="editStudentAccount(${account.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function searchStudentAccounts() {
            const searchInput = document.getElementById('studentAccountsSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderStudentAccountsTable(allStudentAccounts);
                return;
            }
            
            const filtered = allStudentAccounts.filter(account => {
                const studentName = `${account.first_name || ''} ${account.last_name || ''}`.toLowerCase();
                const studentId = account.student_id.toLowerCase();
                const username = account.username.toLowerCase();
                const email = (account.email || account.gmail_address || '').toLowerCase();
                
                return studentId.includes(searchTerm) || 
                       studentName.includes(searchTerm) || 
                       username.includes(searchTerm) || 
                       email.includes(searchTerm);
            });
            
            renderStudentAccountsTable(filtered);
        }

        function editStudentAccount(accountId) {
            const account = allStudentAccounts.find(a => a.id === accountId);
            if (!account) {
                alert('Account not found');
                return;
            }
            
            // Populate edit form
            document.getElementById('editStudentId').value = account.student_id;
            document.getElementById('editUsername').value = account.username;
            document.getElementById('editEmail').value = account.email || account.gmail_address || '';
            document.getElementById('editAccountStatus').value = account.account_status || 'active';
            document.getElementById('enablePasswordReset').checked = false;
            document.getElementById('passwordResetSection').style.display = 'none';
            
            // Store the account ID for save operation
            document.getElementById('editStudentAccountForm').dataset.accountId = accountId;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editStudentAccountModal'));
            modal.show();
        }

        async function saveEditStudent() {
            const form = document.getElementById('editStudentAccountForm');
            const accountId = form.dataset.accountId;
            const email = document.getElementById('editEmail').value.trim();
            const status = document.getElementById('editAccountStatus').value;
            const resetPassword = document.getElementById('enablePasswordReset').checked;
            
            if (!email) {
                alert('Email is required');
                return;
            }
            
            try {
                const response = await fetch(`/api/student-accounts/${accountId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        account_status: status,
                        reset_password: resetPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Student account updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentAccountModal'));
                    modal.hide();
                    
                    // Reload accounts
                    loadStudentAccounts();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update account'));
                }
            } catch (err) {
                console.error('Error saving student account:', err);
                alert('Error saving changes: ' + err.message);
            }
        }

        // Add search event listener when tab is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('studentAccountsSearch');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchStudentAccounts);
                searchInput.addEventListener('change', searchStudentAccounts);
            }

            // Password reset toggle
            const passwordResetCheckbox = document.getElementById('enablePasswordReset');
            if (passwordResetCheckbox) {
                passwordResetCheckbox.addEventListener('change', function() {
                    const section = document.getElementById('passwordResetSection');
                    section.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Initialize from hash or default to dashboard
        (function initTabs(){
            const hash = location.hash?.replace('#','') || 'dashboardHome';
            showTab(hash);
            
            // Load student accounts when that tab is clicked
            if (hash === 'studentAccounts') {
                loadStudentAccounts();
            }
            
            // Bind clicks for in-page links in sidebar
            document.querySelectorAll('#drawerTabs a[href^="#"]').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = a.getAttribute('href').slice(1);
                    showTab(id);
                    
                    // Load student accounts when clicking that tab
                    if (id === 'studentAccounts') {
                        loadStudentAccounts();
                    }
                });
            });
            // Respond to back/forward
            window.addEventListener('hashchange', () => {
                const h = location.hash.replace('#','');
                if (h) {
                    showTab(h);
                    if (h === 'studentAccounts') {
                        loadStudentAccounts();
                    }
                }
            });
        })();

    // --- Enrollment table filtering UI ---
    (function initEnrollmentFilters(){
        try {
            const tableBody = document.getElementById('enrollmentTableBody');
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const sySelect = document.getElementById('filterSY');
            const gradeSelect = document.getElementById('filterGrade');
            const searchInput = document.getElementById('filterSearch');
            const searchBtn = document.getElementById('filterSearchBtn');
            const clearBtn = document.getElementById('filterClearBtn');

            const years = new Set();
            const grades = new Set();

            rows.forEach(r => {
                const sy = (r.dataset.schoolYear || '').toString();
                const g = (r.dataset.grade || '').toString();
                if (sy) years.add(sy);
                if (g) grades.add(g);
            });

            Array.from(years).sort().forEach(y => {
                const o = document.createElement('option'); o.value = y; o.textContent = y; sySelect.appendChild(o);
            });
            Array.from(grades).sort().forEach(g => {
                const o = document.createElement('option'); o.value = g; o.textContent = g; gradeSelect.appendChild(o);
            });

            function applyFilters() {
                const sy = (sySelect.value || '').toString();
                const grade = (gradeSelect.value || '').toString();
                const term = (searchInput.value || '').toString().trim().toLowerCase();

                rows.forEach(r => {
                    // skip template/no-data row which may not have dataset
                    const rsy = (r.dataset.schoolYear||'').toString();
                    const rgrade = (r.dataset.grade||'').toString();
                    const rlearner = (r.dataset.learner||'').toString();
                    const rlrn = (r.dataset.lrn||'').toString();

                    let visible = true;
                    if (sy && rsy !== sy) visible = false;
                    if (grade && rgrade !== grade) visible = false;
                    if (term) {
                        if (!(rlrn.includes(term) || rlearner.includes(term))) visible = false;
                    }

                    r.style.display = visible ? '' : 'none';
                });
            }

            sySelect.addEventListener('change', applyFilters);
            gradeSelect.addEventListener('change', applyFilters);
            searchBtn.addEventListener('click', (e) => { e.preventDefault(); applyFilters(); });
            searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); applyFilters(); } });
            clearBtn.addEventListener('click', (e) => { e.preventDefault(); sySelect.value=''; gradeSelect.value=''; searchInput.value=''; applyFilters(); });
        } catch (err) { console.warn('Enrollment filter init failed', err); }
    })();

    // --- History table filtering UI ---
    (function initHistoryFilters(){
        try {
            const table = document.querySelector('#historyArchive table.table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const gradeSelect = document.getElementById('historyFilterGrade');
            const searchInput = document.getElementById('historyFilterSearch');
            const searchBtn = document.getElementById('historyFilterSearchBtn');
            const clearBtn = document.getElementById('historyFilterClearBtn');

            const grades = new Set();
            rows.forEach(r => { const g = (r.dataset.grade||'').toString(); if (g) grades.add(g); });
            Array.from(grades).sort().forEach(g => { const o = document.createElement('option'); o.value=g; o.textContent=g; gradeSelect.appendChild(o); });

            function applyHistoryFilters(){
                const grade = (gradeSelect.value||'').toString();
                const term = (searchInput.value||'').toString().trim().toLowerCase();
                rows.forEach(r => {
                    const rgrade = (r.dataset.grade||'').toString();
                    const rlearner = (r.dataset.learner||'').toString();
                    const rtoken = (r.dataset.token||'').toString();
                    const rlrn = (r.dataset.lrn||'').toString();
                    let visible = true;
                    if (grade && rgrade !== grade) visible = false;
                    if (term) {
                        if (!(rlearner.includes(term) || rtoken.includes(term) || rlrn.includes(term))) visible = false;
                    }
                    r.style.display = visible ? '' : 'none';
                });
            }

            gradeSelect.addEventListener('change', applyHistoryFilters);
            searchBtn.addEventListener('click', (e)=>{ e.preventDefault(); applyHistoryFilters(); });
            searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); applyHistoryFilters(); } });
            clearBtn.addEventListener('click', (e)=>{ e.preventDefault(); gradeSelect.value=''; searchInput.value=''; applyHistoryFilters(); });
        } catch (err) { console.warn('History filter init failed', err); }
    })();

    // --- FORM SUBMISSION LOGIC (for the current tab) ---
    document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;

        // Clear previous validation state
        function clearValidation() {
            form.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));
            form.querySelectorAll('.validation-message').forEach(m => m.remove());
            const alert = document.getElementById('formAlert');
            if (alert) { alert.classList.add('d-none'); alert.innerHTML = ''; }
        }

        clearValidation();

        // Fields to validate: selector and friendly name
        const requiredFields = [
            { selector: '[name="gmail"]', name: 'Gmail Address' },
            { selector: '[name="schoolYear"]', name: 'School Year' },
            { selector: '[name="gradeLevel"]', name: 'Grade Level' },
            { selector: '[name="lastName"]', name: 'Last Name' },
            { selector: '[name="givenName"]', name: 'First Name' },
            { selector: '[name="birthday"]', name: 'Birthday' },
            { selector: '[name="age"]', name: 'Age' },
            { selector: '[name="sex"]', name: 'Sex' },
            { selector: '[name="address"]', name: 'Current Address' },
            { selector: '[name="printedName"]', name: 'Printed Name' },
            { selector: '[name="date"]', name: 'Date' }
        ];

        const missing = [];
        requiredFields.forEach(f => {
            const el = form.querySelector(f.selector);
            if (!el) return; // skip if element not present
            const val = (el.type === 'checkbox' || el.type === 'radio') ? (el.checked ? el.value : '') : (el.value || '').toString().trim();
            if (!val) {
                missing.push(f.name);
                el.classList.add('validation-error');
                // insert message
                const msg = document.createElement('div');
                msg.className = 'validation-message text-danger small';
                msg.textContent = f.name + ' is required.';
                if (el.parentNode) el.parentNode.insertBefore(msg, el.nextSibling);
            }
        });

        if (missing.length > 0) {
            const alert = document.getElementById('formAlert');
            if (alert) {
                alert.innerHTML = '<strong>Please fix the following fields:</strong><ul style="margin-bottom:0; margin-top:.5rem">' + missing.map(m => '<li>' + m + '</li>').join('') + '</ul>';
                alert.classList.remove('d-none');
            } else {
                alert('Missing required fields: ' + missing.join(', '));
            }
            // focus first invalid
            const firstInvalid = form.querySelector('.validation-error');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus({ preventScroll: true });
            }
            return; // stop submission
        }

        // Passed validation - prepare and submit
        const formData = new FormData(form);
        // Add signature canvas data if exists
        const signatureCanvas = document.getElementById('signaturePad');
        if (signatureCanvas) {
            const signatureDataURL = signatureCanvas.toDataURL();
            if (signatureDataURL && signatureDataURL !== 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==') {
                formData.append('signatureData', signatureDataURL);
            }
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) { submitBtn.textContent = 'Adding...'; submitBtn.disabled = true; }

        // Submit to server
        fetch('/add-registration', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // show a non-blocking pop-out toast if available, otherwise fall back to the in-page alert
                try {
                    showToast(data.message || 'Registration added successfully!', 'success');
                } catch (e) {
                    const a = document.getElementById('formAlert');
                    if (a) { a.className = 'alert alert-success'; a.textContent = 'Registration added successfully! Redirecting...'; a.classList.remove('d-none'); }
                }
                setTimeout(() => window.location.reload(), 900);
            } else {
                try { showToast('Error: ' + (data.message || 'Failed to add registration'), 'error'); } catch (e) {
                    const a = document.getElementById('formAlert');
                    if (a) { a.className = 'alert alert-danger'; a.textContent = 'Error: ' + (data.message || 'Failed to add registration'); a.classList.remove('d-none'); }
                    else {
                        // Create a temporary in-page alert instead of a blocking alert()
                        try {
                            const form = document.getElementById('enrollmentForm') || document.querySelector('form');
                            const temp = document.createElement('div');
                            temp.className = 'alert alert-danger';
                            temp.textContent = 'Error: ' + (data.message || 'Failed to add registration');
                            temp.style.marginBottom = '1rem';
                            if (form && form.parentNode) form.parentNode.insertBefore(temp, form);
                            else document.body.insertBefore(temp, document.body.firstChild);
                            setTimeout(() => { try { temp.remove(); } catch(_){} }, 6000);
                        } catch(_) {
                            console.error('Registration error:', data.message || 'Failed to add registration');
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const a = document.getElementById('formAlert');
            if (a) { a.className = 'alert alert-danger'; a.textContent = 'An error occurred while adding the registration.'; a.classList.remove('d-none'); }
            else alert('An error occurred while adding the registration.');
        })
        .finally(() => {
            // Reset button state
            if (submitBtn) { submitBtn.textContent = originalText; submitBtn.disabled = false; }
        });
    });

    // View registration function
    function viewRegistration(id) {
        alert('View functionality will be implemented soon for registration ID: ' + id);
    }

    // --- Signature Pad Logic ---
    const canvas = document.getElementById('signaturePad');
    let ctx = null;
    let drawing = false;
    if (canvas) {
        ctx = canvas.getContext('2d');
        canvas.addEventListener('mousedown', function(e) {
            drawing = true;
            if (ctx) { ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); }
        });
        canvas.addEventListener('mousemove', function(e) {
            if (drawing && ctx) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.strokeStyle = "#dc2626";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        });
        canvas.addEventListener('mouseup', function() { drawing = false; });
        canvas.addEventListener('mouseleave', function() { drawing = false; });
    }

    function clearSignaturePad() {
        if (ctx && canvas) ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- Modal Signature Pad Logic ---
    const maximizeBtn = document.getElementById('maximizeSignaturePad');
    const modalElement = document.getElementById('signaturePadModal');
    const modalCanvas = document.getElementById('signaturePadModalCanvas');
    let modalCtx = null;
    let modalDrawing = false;
    let signatureModal = null;

    if (modalCanvas) {
        modalCtx = modalCanvas.getContext('2d');
    }
    if (modalElement && typeof bootstrap !== 'undefined') {
        try { signatureModal = new bootstrap.Modal(modalElement); } catch (e) { signatureModal = null; }
    }

    // Copy signature from main canvas to modal canvas
    if (maximizeBtn && modalCtx && canvas && signatureModal) {
        maximizeBtn.addEventListener('click', function() {
            modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
            const dataURL = canvas.toDataURL();
            const img = new window.Image();
            img.onload = function() {
                modalCtx.drawImage(img, 0, 0, modalCanvas.width, modalCanvas.height);
            };
            img.src = dataURL;
            signatureModal.show();
        });
    }

    // Modal drawing events
    if (modalCanvas && modalCtx) {
        modalCanvas.addEventListener('mousedown', function(e) {
            modalDrawing = true;
            if (modalCtx) { modalCtx.beginPath(); modalCtx.moveTo(e.offsetX, e.offsetY); }
        });
        modalCanvas.addEventListener('mousemove', function(e) {
            if (modalDrawing && modalCtx) {
                modalCtx.lineTo(e.offsetX, e.offsetY);
                modalCtx.strokeStyle = "#dc2626";
                modalCtx.lineWidth = 2;
                modalCtx.stroke();
            }
        });
        modalCanvas.addEventListener('mouseup', function() { modalDrawing = false; });
        modalCanvas.addEventListener('mouseleave', function() { modalDrawing = false; });
    }

    function clearModalSignaturePad() {
        if (modalCtx && modalCanvas) modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
    }

    // Copy signature from modal canvas to main canvas
    const doneModalBtn = document.getElementById('doneModalSignaturePad');
    if (doneModalBtn && modalCanvas && canvas && ctx && signatureModal) {
        doneModalBtn.addEventListener('click', function() {
            const dataURL = modalCanvas.toDataURL();
            const img = new window.Image();
            img.onload = function() {
                if (ctx && canvas) { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); }
            };
            img.src = dataURL;
            signatureModal.hide();
        });
    }

    const clearModalBtn = document.getElementById('clearModalSignaturePad');
    if (clearModalBtn) clearModalBtn.addEventListener('click', clearModalSignaturePad);

    // Close modal button
    const closeModalBtn = document.getElementById('closeSignaturePadModal');
    if (closeModalBtn && signatureModal) {
        closeModalBtn.addEventListener('click', function() { signatureModal.hide(); });
    }

    // --- LOGOUT CONFIRMATION LOGIC ---
    function confirmLogout() {
        try {
            const modalElement = document.getElementById('logoutConfirmModal');
            if (!modalElement) {
                console.error('Modal element not found');
                if (confirm('Are you sure you want to log out?')) {
                    proceedLogout();
                }
                return;
            }
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const logoutModal = new bootstrap.Modal(modalElement);
                logoutModal.show();
            } else {
                console.warn('Bootstrap not available, using confirm dialog');
                if (confirm('Are you sure you want to log out?')) {
                    proceedLogout();
                }
            }
        } catch (e) {
            console.error('Logout modal error:', e);
            if (confirm('Are you sure you want to log out?')) {
                proceedLogout();
            }
        }
    }

    function proceedLogout() {
        // Show loading state
        try {
            const yesBtn = document.querySelector('[onclick="proceedLogout()"]');
            if (yesBtn) {
                yesBtn.disabled = true;
                yesBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Logging out...';
            }
        } catch (e) { console.warn('Could not update button:', e); }
        
        // Redirect to logout endpoint
        setTimeout(() => {
            window.location.href = '/logout-registrar';
        }, 300);
    }

    // Enrollment request functions
    const fillDetailsModal = new bootstrap.Modal(document.getElementById('fillDetailsModal'));

    function openFillDetails(requestId) {
        // Reset form
        document.getElementById('fillDetailsForm').reset();
        document.getElementById('fillRequestId').value = requestId;
        // Load data
        fetch(`/api/enrollment-request/${requestId}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) throw new Error(data.error || 'Failed to load request');
                const req = data.request;
                
                // Read-only Request Info
                document.getElementById('view_request_token').textContent = req.request_token || '-';
                document.getElementById('view_gmail_address').textContent = req.gmail_address || '-';
                if (req.created_at) {
                    document.getElementById('view_created_at').textContent = new Date(req.created_at).toLocaleString('en-PH', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Manila'
                    });
                } else {
                    document.getElementById('view_created_at').textContent = '-';
                }

                // Read-only Learner Info
                document.getElementById('view_school_year').textContent = req.school_year || '-';
                document.getElementById('view_grade_level').textContent = req.grade_level || '-';
                document.getElementById('view_lrn').textContent = req.lrn || 'N/A';
                document.getElementById('view_last_name').textContent = req.last_name || '-';
                document.getElementById('view_first_name').textContent = req.first_name || '-';
                document.getElementById('view_middle_name').textContent = req.middle_name || '-';
                document.getElementById('view_ext_name').textContent = req.ext_name || '-';
                if (req.birthday) {
                    document.getElementById('view_birthday').textContent = new Date(req.birthday).toLocaleDateString('en-PH', {
                        year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Manila'
                    });
                } else {
                    document.getElementById('view_birthday').textContent = '-';
                }
                document.getElementById('view_age').textContent = req.age || '-';
                document.getElementById('view_sex').textContent = req.sex || '-';
                document.getElementById('view_printed_name').textContent = req.printed_name || '-';

                // Format enrollee type for display
                const enrolleeTypeDisplay = req.enrollee_type 
                    ? req.enrollee_type
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ')
                    : 'N/A';
                
                // Enrollee Type Detail (in documents section)
                document.getElementById('view_enrollee_type_detail').textContent = enrolleeTypeDisplay;
                
                // Helper function to create document display with view button
                function createDocumentDisplay(docData, docName) {
                    if (docData) {
                        const btnId = `view_doc_${docName}`;
                        return `âœ“ Submitted <button class="btn btn-sm btn-primary ms-2" id="${btnId}" onclick="viewDocument('${docName}', this)"><i class="bi bi-eye me-1"></i>View</button>`;
                    } else {
                        return 'âœ— Not Submitted';
                    }
                }
                
                document.getElementById('view_birth_cert_psa').innerHTML = createDocumentDisplay(req.birth_cert_psa, 'birth_cert_psa');
                document.getElementById('view_eccd_checklist').innerHTML = createDocumentDisplay(req.eccd_checklist, 'eccd_checklist');
                document.getElementById('view_report_card_previous').innerHTML = createDocumentDisplay(req.report_card_previous, 'report_card_previous');
                document.getElementById('view_sf10_original').innerHTML = createDocumentDisplay(req.sf10_original, 'sf10_original');
                document.getElementById('view_sf10_optional').innerHTML = createDocumentDisplay(req.sf10_optional, 'sf10_optional');
                
                // Store document data globally for viewing
                window.currentEnrollmentDocuments = {
                    birth_cert_psa: req.birth_cert_psa,
                    eccd_checklist: req.eccd_checklist,
                    report_card_previous: req.report_card_previous,
                    sf10_original: req.sf10_original,
                    sf10_optional: req.sf10_optional
                };

                // Editable fields
                document.getElementById('father_name').value = req.father_name || '';
                document.getElementById('mother_name').value = req.mother_name || '';
                document.getElementById('guardian_name').value = req.guardian_name || '';
                document.getElementById('contact_number').value = req.contact_number || '';
                document.getElementById('current_address').value = req.current_address || '';
                document.getElementById('religion_fill').value = req.religion || '';
                document.getElementById('ip_community').value = req.ip_community || '';
                document.getElementById('ip_community_specify').value = req.ip_community_specify || '';
                document.getElementById('pwd_fill').value = req.pwd || '';
                document.getElementById('pwd_specify').value = req.pwd_specify || '';

                // Signature preview
                if (req.signature_image_path) {
                    document.getElementById('signature_preview').src = req.signature_image_path;
                    document.getElementById('signature_preview_container').style.display = 'block';
                    document.getElementById('signature_no_preview').style.display = 'none';
                } else {
                    document.getElementById('signature_preview_container').style.display = 'none';
                    document.getElementById('signature_no_preview').style.display = 'block';
                }

                fillDetailsModal.show();
            })
            .catch(err => {
                console.error(err);
                alert('Unable to load request details.');
            });
    }

    document.getElementById('saveFillDetails').addEventListener('click', function() {
        const requestId = document.getElementById('fillRequestId').value;
        const payload = {
            father_name: document.getElementById('father_name').value.trim(),
            mother_name: document.getElementById('mother_name').value.trim(),
            guardian_name: document.getElementById('guardian_name').value.trim(),
            contact_number: document.getElementById('contact_number').value.trim(),
            current_address: document.getElementById('current_address').value.trim(),
            religion: document.getElementById('religion_fill').value.trim(),
            ip_community: document.getElementById('ip_community').value,
            ip_community_specify: document.getElementById('ip_community_specify').value.trim(),
            pwd: document.getElementById('pwd_fill').value,
            pwd_specify: document.getElementById('pwd_specify').value.trim()
        };
        fetch(`/update-request/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.showAlert('Details saved.').then(()=>{
                        fillDetailsModal.hide();
                        location.reload();
                    });
                } else {
                    window.showAlert('Error: ' + (data.message || 'Failed to save changes'));
                }
            })
            .catch(err => {
                console.error(err);
                window.showAlert('An error occurred while saving changes.');
            });
    });
    async function approveRequest(requestId) {
        try {
            // Get enrollment request data
            const [enrollmentResponse, nextIdResponse] = await Promise.all([
                fetch(`/api/enrollment-request/${requestId}`),
                fetch('/api/next-student-id')
            ]);
            
            const enrollmentData = await enrollmentResponse.json();
            const nextIdData = await nextIdResponse.json();
            
            if (!enrollmentData.success || !nextIdData.success) {
                window.showAlert('Error: Could not fetch enrollment details');
                return;
            }
            
            const enrollment = enrollmentData.request;
            const nextStudentId = nextIdData.studentId;
            
            // Store the request ID for later confirmation
            window.currentEnrollmentRequestId = requestId;
            
            // Populate modal with enrollment data
            document.getElementById('accountModalStudentName').value = `${enrollment.first_name} ${enrollment.last_name}`;
            
            // Display the actual next student ID that will be generated
            document.getElementById('accountModalUsername').value = nextStudentId;
            document.getElementById('accountModalPassword').value = nextStudentId;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createAccountModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error:', error);
            window.showAlert('An error occurred while fetching enrollment details');
        }
    }
    
    async function confirmCreateAccount() {
        try {
            const confirmBtn = document.getElementById('confirmCreateAccountBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
            
            const enrollmentRequestId = window.currentEnrollmentRequestId;
            
            // Call API to create student account
            const response = await fetch('/api/create-student-account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enrollmentRequestId: enrollmentRequestId })
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to create account');
            }
            
            const account = result.account;
            
            // Hide the current modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createAccountModal'));
            modal.hide();
            
            // Show success modal after a brief delay
            setTimeout(() => {
                showAccountCreationSuccess(account);
            }, 400);
            
        } catch (error) {
            console.error('Error:', error);
            const confirmBtn = document.getElementById('confirmCreateAccountBtn');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirm & Create Account';
            window.showAlert('Error creating account: ' + error.message);
        }
    }
    
    function showAccountCreationSuccess(account) {
        // Create a professional success modal
        const html = `
        <div class="modal fade" id="accountSuccessModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body text-center py-5">
                        <div style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <h4 class="modal-title mb-3 fw-bold text-success">Account Created Successfully! âœ…</h4>
                        <p class="text-muted mb-4">The student account has been created and saved to the records.</p>
                        
                        <div class="card" style="background-color: #f0fdf4; border: 2px solid #10b981;">
                            <div class="card-body text-start">
                                <h6 class="fw-bold mb-3 text-success">Generated Login Credentials:</h6>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Student ID</small>
                                    <code style="font-size: 1.1rem; color: #059669; user-select: all; cursor: pointer;" class="d-block p-2 bg-white rounded border">${account.student_id}</code>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Username (for login)</small>
                                    <code style="font-size: 1.1rem; color: #059669; user-select: all; cursor: pointer;" class="d-block p-2 bg-white rounded border">${account.username}</code>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Initial Password (for login)</small>
                                    <code style="font-size: 1.1rem; color: #059669; user-select: all; cursor: pointer;" class="d-block p-2 bg-white rounded border">${account.initialPassword}</code>
                                </div>
                                <div class="pt-2 border-top">
                                    <small class="text-muted">
                                        <i class="bi bi-envelope me-1"></i>Credentials sent to: <strong>${account.email}</strong>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success mt-4 mb-3" role="alert">
                            <i class="bi bi-check2-circle me-2"></i>
                            <small><strong>Account Saved!</strong> The student record has been moved to <strong>History of Requests</strong> with the new account information linked.</small>
                        </div>

                        <div class="alert alert-info mb-0" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <small><strong>View Account:</strong> Click on <strong>"ðŸ“š History of Requests"</strong> in the left menu to see the approved record with account details.</small>
                        </div>
                    </div>
                    <div class="modal-footer border-top bg-light">
                        <button type="button" class="btn btn-success w-100" data-bs-dismiss="modal" onclick="window.location.href = '#historyArchive'; setTimeout(() => window.location.reload(), 100);">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reload & View Records
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
        
        // Append modal to body
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = html;
        document.body.appendChild(modalContainer);
        
        // Show the modal
        const successModal = new bootstrap.Modal(document.getElementById('accountSuccessModal'));
        successModal.show();
        
        // Clean up when modal is hidden
        document.getElementById('accountSuccessModal').addEventListener('hidden.bs.modal', function() {
            modalContainer.remove();
        });
    }


    async function rejectRequest(requestId) {
        try {
            const reason = await window.showPrompt('Reject registration', 'Please provide a reason for rejection:', 'Enter reason here');
            if (reason === null) return; // user cancelled
            if (!reason.trim()) {
                return window.showAlert('Rejection reason is required');
            }
            const response = await fetch(`/reject-request/${requestId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reason: reason.trim() }) });
            const data = await response.json();
            if (data.success) {
                await window.showAlert('Registration request rejected');
                location.reload();
            } else {
                window.showAlert('Error: ' + (data.message || 'Failed to reject request'));
            }
        } catch (error) {
            console.error('Error:', error);
            window.showAlert('An error occurred while rejecting the request');
        }
    }
    // Expose functions globally so inline `onclick` handlers in the table can call them
    // (The script runs inside an IIFE; assign to window explicitly.)
    try {
        window.openFillDetails = openFillDetails;
        window.approveRequest = approveRequest;
        window.rejectRequest = rejectRequest;
        window.viewRegistration = viewRegistration;
        window.confirmLogout = confirmLogout;
        window.proceedLogout = proceedLogout;
        window.confirmCreateAccount = confirmCreateAccount;
    } catch (e) {
        // ignore if window not available (very unlikely in browser)
    }
}catch(err){console.error('Registrar dashboard script error:', err);} })();</script>
    <script src="/js/genericConfirm.js"></script>
    <script src="/js/toast.js"></script>
</body>
</html>